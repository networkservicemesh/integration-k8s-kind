---
name: ci
on:
  pull_request:
  push:
    branches:
      - 'release/**'

env:
  KIND_VERSION: v0.22.0

jobs:
  yamllint:
    uses: networkservicemesh/.github/.github/workflows/yamllint.yaml@main

  shellcheck:
    uses: networkservicemesh/.github/.github/workflows/shellcheck.yaml@main

  golangci-lint:
    uses: networkservicemesh/.github/.github/workflows/golangci-lint.yaml@main

  exclude-fmt-errorf:
    uses: networkservicemesh/.github/.github/workflows/exclude-fmt-errorf.yaml@main

  checkgomod:
    uses: networkservicemesh/.github/.github/workflows/checkgomod.yaml@main

  ### SINGLE CLUSTER
  kind:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - v1.28.0
          - v1.27.2
          - v1.26.4
          - v1.25.11
          - v1.24.15
          - v1.23.17
          - v1.22.17
          - v1.21.14
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
      - uses: actions/setup-go@v5
        with:
          go-version: 1.20.5
          token: ${{ github.token }}
      - name: Set go env
        run: |
          echo GOPATH=$GITHUB_WORKSPACE >> $GITHUB_ENV
          echo GO111MODULE=on >> $GITHUB_ENV
          echo $GITHUB_WORKSPACE/bin >> $GITHUB_PATH
      - uses: actions/checkout@v4
        with:
          path: ${{ github.workspace }}/src/github.com/${{ github.repository }}
      - uses: helm/kind-action@v1
        with:
          config: src/github.com/${{ github.repository }}/cluster-config.yaml
          version: ${{ env.KIND_VERSION }}
          node_image: kindest/node:${{ matrix.image }}
          cluster_name: kind
      - name: Check kind cluster
        run: |
          kubectl version
          kubectl cluster-info
          kubectl get pods -n kube-system
          echo "current-context:" $(kubectl config current-context)
          echo "environment-kubeconfig:" ${KUBECONFIG}
        working-directory: ${{ github.workspace }}/src/github.com/${{ github.repository }}
      - name: Set loadbalancer CIDR
        run: |
          echo CLUSTER_CIDR="172.18.1.128/25" >> $GITHUB_ENV
      - name: Integration tests
        run: |
          go test -count 1 -timeout 2h30m -race -v ./tests_single -parallel 4
        env:
          ARTIFACTS_DIR: ${{ matrix.image }}-logs/${{ matrix.image }}
        working-directory: ${{ github.workspace }}/src/github.com/${{ github.repository }}
      - name: Upload artifacts
        if: ${{ success() || failure() || cancelled() }}
        uses: actions/upload-artifact@v3
        with:
          name: Single logs
          path: ${{ github.workspace }}/src/github.com/${{ github.repository }}/tests_single/${{ matrix.image }}-logs
